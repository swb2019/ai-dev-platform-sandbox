name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  security-scans:
    name: CI / Security Scans
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run gitleaks detect
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
          GITLEAKS_VERSION: 8.18.2
          GITLEAKS_ENABLE_SUMMARY: 'false'

      - name: Run Semgrep CI scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: semgrep.yml

  quality-gates:
    name: CI / Quality Gates
    runs-on: ubuntu-latest
    needs: security-scans
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Test
        run: pnpm test

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm type-check

      - name: Format check
        run: pnpm format:check

      - name: Build
        run: pnpm build

  supply_chain:
    name: CI / Supply Chain
    runs-on: ubuntu-latest
    needs: quality-gates
    permissions:
      contents: read
      packages: write
      id-token: write
    env:
      IMAGE_REPO: ghcr.io/${{ github.repository }}/web
      IMAGE_TAG: ${{ github.sha }}
      SBOM_OUTPUT: artifacts/sbom/web-${{ github.sha }}-cyclonedx.json
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install supply chain tooling
        run: bash scripts/tools/install-supply-chain-tools.sh

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build container image
        run: pnpm docker:build:web

      - name: Scan container image
        run: pnpm docker:scan:web

      - name: Generate SBOM
        run: pnpm docker:sbom:web

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-sbom-${{ github.sha }}
          path: ${{ env.SBOM_OUTPUT }}
          if-no-files-found: error

      - name: Push image to GHCR
        run: docker push "${IMAGE_REPO}:${IMAGE_TAG}"

      - name: Sign image and SBOM
        run: pnpm docker:sign:web
